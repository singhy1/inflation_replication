
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      StataNow 19.5
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2025 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-782-8272        https://www.stata.com
                                   979-696-4600        service@stata.com

Stata license: 22-user 8-core network, expiring 30 Jun 2026
Serial number: 501909306443
  Licensed to: Giyoung Kwon
               Becker Friedman Institute

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.

. do ./4_moments/4_0_build.do 

. * Yash Singh 
. * date: 7/11/24 
. * goal: this script takes in the raw asec data and performs some cleaning and
>  sample selection. 
. 
. set more off

. 
. local os : environment OS

. local is_win = strpos("`os'", "Windows") > 0

. 
. * Get username
. local user : environment USER

. if "`user'" == "" local user : environment USERNAME  // For Windows

. 
. * Define base path depending on OS
. if `is_win' {
.     global proj_dir "C:/Users/`user'/Dropbox/Labor_Market_PT/replication/fina
> l" // Maybe different?
. }

. else {
.     global proj_dir "/Users/`user'/Library/CloudStorage/Dropbox/Labor_Market_
> PT/replication/final"
. }

. 
. global data_dir "$proj_dir/data/moments/raw"

. global temp_dir "$proj_dir/data/moments/temp"

. global output_dir "$proj_dir/data/moments/temp"

. 
. * CPI Cleanings 
. import excel "$data_dir/CPI.xls", cellrange(A11) firstrow clear
(2 vars, 933 obs)

. 
. * Rename columns
. rename observation_date date_monthly

. rename CPIAUCSL cpi

. 
. format date_monthly %td

. 
. sort date_monthly

. gen inflation_4m = (cpi / cpi[_n-4] - 1) * 100 if _n > 4
(4 missing values generated)

. gen inflation_12m = (cpi / cpi[_n-12] - 1) * 100 if _n > 12
(12 missing values generated)

. 
. 
. gen cpi_12m_lag = cpi[_n-12] if _n > 12
(12 missing values generated)

. 
. gen year = year(date_monthly)

. 
. bysort year: egen avg_cpi_12m_lag = mean(cpi_12m_lag)
(12 missing values generated)

. 
. 
. save "$temp_dir/cpi_clean.dta", replace
(file
    /Users/giyoung/Library/CloudStorage/Dropbox/Labor_Market_PT/replication/f
    > inal/data/moments/temp/cpi_clean.dta not found)
file
    /Users/giyoung/Library/CloudStorage/Dropbox/Labor_Market_PT/replication/f
    > inal/data/moments/temp/cpi_clean.dta saved

. 
. clear

. quietly infix                  ///
>   int     year        1-4      ///
>   long    serial      5-9      ///
>   byte    month       10-11    ///
>   double  cpsid       12-25    ///
>   byte    asecflag    26-26    ///
>   double  asecwth     27-37    ///
>   byte    pernum      38-39    ///
>   double  cpsidp      40-53    ///
>   double  cpsidv      54-68    ///
>   double  asecwt      69-79    ///
>   double  earnweek2   80-87    ///
>   double  hourwage2   88-92    ///
>   byte    age         93-94    ///
>   byte    sex         95-95    ///
>   int     race        96-98    ///
>   byte    empstat     99-100   ///
>   byte    labforce    101-101  ///
>   int     occ1990     102-104  ///
>   int     ind1990     105-107  ///
>   byte    classwkr    108-109  ///
>   int     uhrswork1   110-112  ///
>   byte    durunem2    113-114  ///
>   byte    whyunemp    115-115  ///
>   int     educ        116-118  ///
>   double  earnwt      119-128  ///
>   int     occ90ly     129-131  ///
>   int     ind90ly     132-134  ///
>   byte    wkswork1    135-136  ///
>   int     uhrsworkly  137-139  ///
>   double  incwage     140-147  ///
>   byte    paidhour    148-148  ///
>   using `"$data_dir/cps_00110.dat"'

. 
. replace asecwth    = asecwth    / 10000
(1,550,977 real changes made)

. replace asecwt     = asecwt     / 10000
(1,550,977 real changes made)

. replace earnweek2  = earnweek2  / 100
(107,269 real changes made)

. replace hourwage2  = hourwage2  / 100
(1,550,977 real changes made)

. replace earnwt     = earnwt     / 10000
(205,205 real changes made)

. 
. format cpsid      %14.0f

. format asecwth    %11.4f

. format cpsidp     %14.0f

. format cpsidv     %15.0f

. format asecwt     %11.4f

. format earnweek2  %8.2f

. format hourwage2  %5.2f

. format earnwt     %10.4f

. format incwage    %8.0f

. 
. label var year       `"Survey year"'

. label var serial     `"Household serial number"'

. label var month      `"Month"'

. label var cpsid      `"CPSID, household record"'

. label var asecflag   `"Flag for ASEC"'

. label var asecwth    `"Annual Social and Economic Supplement Household weight
> "'

. label var pernum     `"Person number in sample unit"'

. label var cpsidp     `"CPSID, person record"'

. label var cpsidv     `"Validated Longitudinal Identifier"'

. label var asecwt     `"Annual Social and Economic Supplement Weight"'

. label var earnweek2  `"Weekly earnings (rounded)"'

. label var hourwage2  `"Hourly wage (rounded)"'

. label var age        `"Age"'

. label var sex        `"Sex"'

. label var race       `"Race"'

. label var empstat    `"Employment status"'

. label var labforce   `"Labor force status"'

. label var occ1990    `"Occupation, 1990 basis"'

. label var ind1990    `"Industry, 1990 basis"'

. label var classwkr   `"Class of worker "'

. label var uhrswork1  `"Hours usually worked per week at main job"'

. label var durunem2   `"Continuous weeks unemployed, intervalled"'

. label var whyunemp   `"Reason for unemployment"'

. label var educ       `"Educational attainment recode"'

. label var earnwt     `"Earnings weight"'

. label var occ90ly    `"Occupation last year, 1990 basis"'

. label var ind90ly    `"Industry last year, 1990 basis"'

. label var wkswork1   `"Weeks worked last year"'

. label var uhrsworkly `"Usual hours worked per week (last yr)"'

. label var incwage    `"Wage and salary income"'

. label var paidhour   `"Paid by the hour"'

. 
. rename year YEAR 

. rename month MONTH 

. rename cpsid CPSID 

. rename cpsidp CPSIDP 

. rename asecwth ASECWTH

. rename pernum PERNUM 

. rename asecwt ASECWT

. rename age AGE 

. rename sex SEX 

. rename race RACE 

. rename empstat EMPSTAT 

. rename labforce LABFORCE 

. rename occ1990 OCC1990

. rename ind1990 IND1990

. rename occ90ly OCC90LY 

. rename ind90ly IND90LY

. rename classwkr CLASSWKR

. rename uhrswork1 UHRSWORK1

. rename earnwt EARNWT

. rename incwage INCWAGE 

. rename wkswork1 WKSWORK1 

. rename hourwage2 HOURWAGE2

. rename earnweek2 EARNWEEK2

. rename educ EDUC 

. rename paidhour PAIDHOUR

. rename durunem2 DURUNEM2 

. 
. 
. * sample selection 
. keep if YEAR >= 2016
(199,024 observations deleted)

. keep if YEAR <= 2019
(620,367 observations deleted)

. 
. * Full-year, Full-Time 
. keep if AGE >= 25
(256,598 observations deleted)

. keep if AGE <= 55 
(176,493 observations deleted)

. 
. * top coding and imputed wages are dropped 
. drop if INCWAGE == 0 
(65,603 observations deleted)

. *drop if INCWAGE > 150000
. 
. drop if WKSWORK1 < 40 
(20,743 observations deleted)

. drop if uhrsworkly  < 35
(20,163 observations deleted)

. 
. * weekly earnings and wages 
. gen weekly_earnings = INCWAGE / WKSWORK1

. 
. * hourly wage
. gen hourly_wage = weekly_earnings/uhrsworkly 

. 
. drop if hourly_wage <= 2.13 
(692 observations deleted)

. 
. 
. * Generate percentiles by year and month
. bysort YEAR MONTH: egen p5_earnings = pctile(weekly_earnings), p(1)

. bysort YEAR MONTH: egen p95_earnings = pctile(weekly_earnings), p(99)

. 
. * Drop observations outside the 3rd and 97th percentiles
. drop if weekly_earnings < p5_earnings | weekly_earnings > p95_earnings
(3,392 observations deleted)

. 
. *drop if weekly_earnings < p5_earnings
. 
. * Clean up
. drop p5_earnings p95_earnings

. 
. 
. 
. * Education 
. gen educ = .
(187,902 missing values generated)

. replace educ = 1 if EDUC < 111
(109,286 real changes made)

. replace educ = 2 if EDUC >= 111
(78,616 real changes made)

. label define educ_label 1 "Less than College" 2 "College+"

. label values educ educ_label

. 
. 
. gen date_monthly = mdy(MONTH, 1, YEAR)

. format date_monthly %td

. 
. * Step 3: Calculate average price index for Q1 2019
. preserve

. use "$temp_dir/cpi_clean.dta", clear

. keep if date_monthly >= td(01jan2019) & date_monthly <= td(01mar2019)
(930 observations deleted)

. summarize cpi

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
         cpi |          3    253.3857    .8599403    252.561    254.277

. local price_index_q1_2019 = r(mean)

. restore

. 
. * Step 4: Merge CPS data with CPI data
. merge m:1 date_monthly using "$temp_dir/cpi_clean.dta", keep(match master) no
> generate

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           187,902  
    -----------------------------------------

. 
. * Step 5: Calculate real weekly and hourly earnings in 2019 dollars
. gen real_wkly_earn = (weekly_earnings / avg_cpi_12m_lag ) * `price_index_q1_2
> 019'

. 
. 
. gen final_wgt = int(ASECWT)

. 
. keep YEAR MONTH CPSIDP final_wgt real_wkly_earn 

. 
. quietly ssc install egenmore

. 
. *** WEEKLY EARNINGS **** 
. preserve 

. sort YEAR 

. by YEAR: egen earn_decile = xtile(real_wkly_earn), nquantiles(10) weight(fina
> l_wgt)

. 
. collapse (mean) real_wkly_earn, by(YEAR earn_decile)

. drop if missing(earn_decile)
(0 observations deleted)

. reshape wide real_wkly_earn, i(YEAR) j(earn_decile)
(j = 1 2 3 4 5 6 7 8 9 10)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations               40   ->   4           
Number of variables                   3   ->   11          
j variable (10 values)      earn_decile   ->   (dropped)
xij variables:
                         real_wkly_earn   ->   real_wkly_earn1 real_wkly_earn2 
> ... real_wkly_earn10
-----------------------------------------------------------------------------

. 
. rename YEAR smpl_yr 

. gen report_yr = smpl_yr[_n-1]
(1 missing value generated)

. drop if missing(report_yr)
(1 observation deleted)

. drop if report_yr < 2016
(0 observations deleted)

. 
. 
. save "$output_dir/asec_weekly_earnings_dist.dta", replace 
(file
    /Users/giyoung/Library/CloudStorage/Dropbox/Labor_Market_PT/replication/f
    > inal/data/moments/temp/asec_weekly_earnings_dist.dta not found)
file
    /Users/giyoung/Library/CloudStorage/Dropbox/Labor_Market_PT/replication/f
    > inal/data/moments/temp/asec_weekly_earnings_dist.dta saved

. export excel using "$output_dir/asec_wkly_earnings_dist.xlsx", firstrow(varia
> bles) replace
file /Users/giyoung/Library/CloudStorage/Dropbox/Labor_Market_PT/replication/fi
> nal/data/moments/temp/asec_wkly_earnings_dist.xlsx saved

. restore 

. 
. 
. egen year_month = group(YEAR MONTH)

. levelsof year_month, local(ym)
1 2 3 4

. 
. gen real_earn_d = .
(187,902 missing values generated)

. 
. quietly foreach y of local ym {

. 
. keep CPSIDP real_earn_d

. duplicates drop

Duplicates in terms of all variables

(78,013 observations deleted)

. duplicates drop CPSIDP, force

Duplicates in terms of CPSIDP

(17,545 observations deleted)

. 
. 
. save "$temp_dir/asec_workers_by_earn_decile.dta", replace
(file
    /Users/giyoung/Library/CloudStorage/Dropbox/Labor_Market_PT/replication/f
    > inal/data/moments/temp/asec_workers_by_earn_decile.dta not found)
file
    /Users/giyoung/Library/CloudStorage/Dropbox/Labor_Market_PT/replication/f
    > inal/data/moments/temp/asec_workers_by_earn_decile.dta saved

. 
. * CPS Basic Monthly Data 
. 
. set more off

. 
. clear

. quietly infix                   ///
>   int     year         1-4      ///
>   long    serial       5-9      ///
>   byte    month        10-11    ///
>   double  hwtfinl      12-21    ///
>   double  cpsid        22-35    ///
>   byte    asecflag     36-36    ///
>   byte    mish         37-37    ///
>   byte    region       38-39    ///
>   byte    pernum       40-41    ///
>   double  wtfinl       42-55    ///
>   double  cpsidv       56-70    ///
>   double  cpsidp       71-84    ///
>   double  earnweek2    85-92    ///
>   double  hourwage2    93-97    ///
>   byte    age          98-99    ///
>   byte    sex          100-100  ///
>   int     race         101-103  ///
>   byte    nativity     104-104  ///
>   byte    empstat      105-106  ///
>   byte    labforce     107-107  ///
>   int     occ1990      108-110  ///
>   byte    classwkr     111-112  ///
>   int     uhrswork1    113-115  ///
>   byte    durunem2     116-117  ///
>   byte    whyunemp     118-118  ///
>   byte    wkstat       119-120  ///
>   byte    empsame      121-122  ///
>   int     educ         123-125  ///
>   double  earnwt       126-135  ///
>   double  compwt       136-149  ///
>   double  lnkfw1mwt    150-163  ///
>   double  hourwage     164-168  ///
>   byte    paidhour     169-169  ///
>   double  earnweek     170-177  ///
>   int     uhrsworkorg  178-180  ///
>   byte    wksworkorg   181-182  ///
>   using `"$data_dir/cps_00108.dat"'

. 
. replace hwtfinl     = hwtfinl     / 10000
(14,711,328 real changes made)

. replace wtfinl      = wtfinl      / 10000
(14,661,344 real changes made)

. replace earnweek2   = earnweek2   / 100
(14,711,355 real changes made)

. replace hourwage2   = hourwage2   / 100
(14,711,355 real changes made)

. replace earnwt      = earnwt      / 10000
(2,992,400 real changes made)

. replace compwt      = compwt      / 10000
(11,799,853 real changes made)

. replace lnkfw1mwt   = lnkfw1mwt   / 10000
(10,129,969 real changes made)

. replace hourwage    = hourwage    / 100
(13,217,863 real changes made)

. replace earnweek    = earnweek    / 100
(13,217,863 real changes made)

. 
. format hwtfinl     %10.4f

. format cpsid       %14.0f

. format wtfinl      %14.4f

. format cpsidv      %15.0f

. format cpsidp      %14.0f

. format earnweek2   %8.2f

. format hourwage2   %5.2f

. format earnwt      %10.4f

. format compwt      %14.4f

. format lnkfw1mwt   %14.4f

. format hourwage    %5.2f

. format earnweek    %8.2f

. 
. label var year        `"Survey year"'

. label var serial      `"Household serial number"'

. label var month       `"Month"'

. label var hwtfinl     `"Household weight, Basic Monthly"'

. label var cpsid       `"CPSID, household record"'

. label var asecflag    `"Flag for ASEC"'

. label var mish        `"Month in sample, household level"'

. label var region      `"Region and division"'

. label var pernum      `"Person number in sample unit"'

. label var wtfinl      `"Final Basic Weight"'

. label var cpsidv      `"Validated Longitudinal Identifier"'

. label var cpsidp      `"CPSID, person record"'

. label var earnweek2   `"Weekly earnings (rounded)"'

. label var hourwage2   `"Hourly wage (rounded)"'

. label var age         `"Age"'

. label var sex         `"Sex"'

. label var race        `"Race"'

. label var nativity    `"Foreign birthplace or parentage"'

. label var empstat     `"Employment status"'

. label var labforce    `"Labor force status"'

. label var occ1990     `"Occupation, 1990 basis"'

. label var classwkr    `"Class of worker "'

. label var uhrswork1   `"Hours usually worked per week at main job"'

. label var durunem2    `"Continuous weeks unemployed, intervalled"'

. label var whyunemp    `"Reason for unemployment"'

. label var wkstat      `"Full or part time status"'

. label var empsame     `"Still working for same employer"'

. label var educ        `"Educational attainment recode"'

. label var earnwt      `"Earnings weight"'

. label var compwt      `"Composite Weight for replicating BLS labor force esti
> mates"'

. label var lnkfw1mwt   `"Longitudinal weight for two adjacent months (BMS only
> )"'

. label var hourwage    `"Hourly wage"'

. label var paidhour    `"Paid by the hour"'

. label var earnweek    `"Weekly earnings"'

. label var uhrsworkorg `"Usual hours worked per week, outgoing rotation groups
> "'

. label var wksworkorg  `"Weeks worked per year, outgoing rotation groups"'

. 
. 
. 
. 
. rename year YEAR 

. rename month MONTH 

. rename cpsid CPSID 

. rename cpsidp CPSIDP 

. rename mish MISH 

. rename wtfinl WTFINL 

. rename age AGE 

. rename sex SEX 

. rename empstat EMPSTAT 

. rename labforce LABFORCE 

. rename occ1990 OCC1990

. rename empsame EMPSAME

. rename whyunemp WHYUNEMP

. rename educ EDUC 

. rename lnkfw1mwt LNKFW1MWT

. rename hourwage HOURWAGE 

. rename paidhour PAIDHOUR 

. rename earnweek EARNWEEK 

. rename uhrsworkorg UHRSWORKORG 

. rename earnwt EARNWT

. rename uhrswork1 UHRSWORK1

. rename hourwage2 HOURWAGE2

. rename earnweek2 EARNWEEK2

. rename race RACE 

. rename region REGION

. rename nativity NATIVITY 

. rename classwkr CLASSWKR

. rename durunem2 DURUNEM2  

. 
. *****************************************************
. *****************************************************
. 
. * Education 
. 
. gen date_monthly = mdy(MONTH, 1, YEAR)

. format date_monthly %td

. 
. gen educ = .
(14,711,355 missing values generated)

. replace educ = 1 if EDUC < 111
(10,937,733 real changes made)

. replace educ = 2 if EDUC >= 111
(3,773,622 real changes made)

. label define educ_label 1 "Less than College" 2 "College+"

. label values educ educ_label

. 
. merge m:1 CPSIDP using "$temp_dir/asec_workers_by_earn_decile.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                    14,113,301
        from master                14,113,300  (_merge==1)
        from using                          1  (_merge==2)

    Matched                           598,055  (_merge==3)
    -----------------------------------------

. drop if _merge == 2
(1 observation deleted)

. drop if _merge == 1 
(14,113,300 observations deleted)

. drop _merge 

. 
. save "$temp_dir/cps_basic_monthly_matched.dta", replace 
(file
    /Users/giyoung/Library/CloudStorage/Dropbox/Labor_Market_PT/replication/f
    > inal/data/moments/temp/cps_basic_monthly_matched.dta not found)
file
    /Users/giyoung/Library/CloudStorage/Dropbox/Labor_Market_PT/replication/f
    > inal/data/moments/temp/cps_basic_monthly_matched.dta saved

. 
. 
end of do-file
